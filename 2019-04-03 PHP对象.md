baiyan

全部视频：https://segmentfault.com/a/1190000018488313

## 类的存储
 - 谈到PHP中的类，我们知道，类是对象的抽象，是所有通过它new出来对象的模板，它是**编译阶段**的产物。一个类被抽象出来，它本身有自己的属性、方法等等要素。如果让我们自己去用C语言实现一个类的存储结构，我们如何设计？
 - 类的几大要素：**类常量、普通属性、静态属性、方法**
 - 类作用域：所有对象之间共享，如类常量、静态属性、静态方法
 - 对象作用域：所有对象之间独享，如普通属性、普通方法
 - 下面我们逐个来看究竟它们是被如何存储的：
### 类常量的存储
 - 类常量不能被修改，属于类作用域，所有对象共享一份类常量。
 - 首先我们举一个PHP类常量的例子：
```php
class A{
	const PI = 3.14;
}
```
  - 这里的PI就是一个类常量。常量名为PI，常量值为3.14。我们可以用两种方式来访问它：
  - 类外：A::PI
  - 类内：self::PI
  - 那么我们看一下常量的存储结构：
```c
struct _zend_class_entry {

	...
	HashTable constants_table;
	...
	
};
```
 - 在PHP7中，类是以一个zend_class_entry结构体来存储的。其中这个constants_table字段，就是用来存储类常量的。我们知道，常量是属于类作用域的，而不是对象作用域，所以它的值被直接放在类结构体中。它是一个hashtable，其中key为常量名，value为常量值，这里还是很好理解的。
### 普通属性的存储
 - 普通属性属于对象作用域，每个对象的属性值可以不同，因为我们现在讲的是类，所以我们在类作用域下讲解一下和普通属性相关的数据在类结构中，究竟在哪里有所体现
 - 举一个PHP普通属性的例子：
```php
class A{
	public $name = 'jby';
}
```
 - 这里name就是属性名，它有一个初始化值为jby，也有两种访问方式：
 - 类内部：$this->name
 - 类外部：对象->name
 - 下面看一下在类结构zend_class_entry中，与普通属性存储相关的字段：
```c
struct _zend_class_entry {

	...
	int default_properties_count; //普通属性的数量
	...
	zval *default_properties_table; //普通属性的初始化值
	...
	HashTable properties_info; //存储对象普通属性的信息
	... 
	
```
 - int default_properties_count字段存储一个类中所有普通属性的数量之和
 - 我们知道，由于普通属性是对象作用域，所以每一个对象下的属性值是不同的，所以不同对象的属性值要放在具体不同对象的结构中去存储。但是，由于PHP允许普通属性具有**初始化值**（如上例的jby），而这个初始化值在所有对象中共享，故初始化值可以放在类作用域中存储，所以初始化的值（如上例的jby）可以直接存储在类结构体下的zval \*default_properties_table这个zval数组中，这个zval就指向一个zend_string，其值为jby
 - 然后我们看具体每个对象中属性的存储。由于普通属性有访问权限（public/protected/private）等额外信息需要存储，所以在类作用域内，存储普通属性的信息需要一个结构体，而且是一个普通变量就要对应一个结构体来存储它的信息。由于类作用域是不能确定每个对象中普通属性的值的（不同对象属性值不同），所以普通属性的值会在对象结构zend_object中以数组的形式存储（后面会讲到）
 - 在类结构zend_class_entry中，我们使用HashTable properties_info这个字段来存储普通属性的信息，而这个字段是一个hashtable，它的key为属性名，value为一个结构体，它就是用来存储普通属性的信息的，叫做zend_property_info:
```c
typedef struct _zend_property_info {
    uint32_t offset; //表示普通成员变量的内存偏移值或静态成员变量的数组索引
    uint32_t flags;  //属性掩码，如public、private、protected及是否为静态属性
    zend_string *name; //属性名
    zend_string *doc_comment; //文档注释信息
    zend_class_entry *ce; //所属类
} zend_property_info;

//flags标识位
#define ZEND_ACC_PUBLIC     0x100
#define ZEND_ACC_PROTECTED  0x200
#define ZEND_ACC_PRIVATE    0x400
#define ZEND_ACC_STATIC      0x01
```
 -  我们看这个存储普通变量信息的结构体。下面的属性名等字段我们很容易理解，那么重点则是这个offset字段。它的字面意义是偏移量，那么这个偏移量是相对于谁的偏移量呢？答案就是相对于每一个对象结构中存储具体属性值的**数组**的偏移量（下面讲到对象结构的时候会具体讲）
 ### 静态属性的存储