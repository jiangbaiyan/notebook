baiyan

全部视频：https://segmentfault.com/a/1190000018488313

## 引入
 - 读这篇文章之前请先阅读[【PHP源码学习】2019-04-09 FastCGI协议1](https://segmentfault.com/a/1190000019767015)
 - 我们知道，客户端、nginx、PHP-FPM之间通信的方式如下：
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/17/1563331385845.png)
 - 那么，我们今天详细解释一下图中的FastCGI协议的部分。学习一个协议，最重要的就是它的格式与语法，看它如何组织所要传输数据的格式，让接收方能够更加方便地接收。那么，这个协议需要解决如下几个问题：

>  - 标识一个请求的开始与结束，让数据包在繁杂的TCP数据流中拥有清晰的边界，方便读取
>  - 传输其他附加参数（如定义在nginx中的fastcgi_param各项参数）
>  - 传输一个客户端发来请求的原始数据

 - 针对上面最后一点的额外的参数，有如下一些形式，大家应该比较熟悉了：
```nginx
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;#脚本文件请求的路径,也就是说当访问127.0.0.1/index.php的时候，需要读取网站根目录下面的index.php文件，如果没有配置这一配置项时，nginx不回去网站根目录下访问.php文件，所以返回空白
fastcgi_param QUERY_STRING $query_string;                        #请求的参数;如?app=123
fastcgi_param REQUEST_METHOD $request_method;                    #请求的动作(GET,POST)
fastcgi_param CONTENT_TYPE $content_type;                        #请求头中的Content-Type字段
fastcgi_param CONTENT_LENGTH $content_length;                    #请求头中的Content-length字段。

fastcgi_param SCRIPT_NAME $fastcgi_script_name;                  #脚本名称 
fastcgi_param REQUEST_URI $request_uri;                          #请求的地址不带参数
fastcgi_param DOCUMENT_URI $document_uri;                        #与$uri相同。 
fastcgi_param DOCUMENT_ROOT $document_root;                      #网站的根目录。在server配置中root指令中指定的值 
fastcgi_param SERVER_PROTOCOL $server_protocol;                  #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。

fastcgi_param GATEWAY_INTERFACE CGI/1.1;                         #cgi 版本
fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;              #nginx 版本号，可修改、隐藏

fastcgi_param REMOTE_ADDR $remote_addr;                          #客户端IP
fastcgi_param REMOTE_PORT $remote_port;                          #客户端端口
fastcgi_param SERVER_ADDR $server_addr;                          #服务器IP地址
fastcgi_param SERVER_PORT $server_port;                          #服务器端口
fastcgi_param SERVER_NAME $server_name;                          #服务器名，域名在server配置中指定的server_name

fastcgi_param PATH_INFO $path_info;                             #可自定义变量

-- PHP only, required if PHP was built with --enable-force-cgi-redirect
fastcgi_param REDIRECT_STATUS 200;
```
 - 那么，我们在PHP中即可打印出上面的服务环境变量。如：
```php
echo $_SERVER['REMOTE_ADDR']
```
 - 为了解决上述问题，我们来由外到内一步步剖析为什么FastCGI协议是这样设计的
## FastCGI的设计思想与结构
 - 首先我们基于之前的客户端、nginx、PHP-FPM之间通信流程图，放大nginx与PHP-FPM之间通信的数据流：
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/17/1563332386398.png)
 - 为了解决我们之前谈到的三个问题，FastCGI把包分为多种类型，每种类型做它自己的事情。如图中的FCGI_BEGIN_REQUEST，负责标识请求的开始，FCGI_PARAMS负责发送nginx中配置的参数，FCGI_STDIN代表标准输入，存储客户端发送的原始字节流数据，这样一次请求的所有数据才能够成功送达到PHP-FPM。我们看一下FastCGI数据包的所有类型：
```c
#define FCGI_BEGIN_REQUEST       1                     //(web->fastcgi)请求开始数据包
#define FCGI_ABORT_REQUEST       2                     //(web->fastcgi)终止请求
#define FCGI_END_REQUEST         3                     //(fastcgi->web)请求结束
#define FCGI_PARAMS              4                     //(web->fastcgi)传递参数
#define FCGI_STDIN               5                     //(web->fastcgi)数据流传输数据
#define FCGI_STDOUT              6                     //(fastcgi->web)数据流传输数据
#define FCGI_STDERR              7                     //(fastcgi->web)数据流传输
#define FCGI_DATA                8                     //(web->fastcgi)数据流传输
#define FCGI_GET_VALUES          9                     //(web->fastcgi)查询fastcgi服务器性能参数
#define FCGI_GET_VALUES_RESULT  10                     //(fastcgi->web)fastcgi性能参数查询返回
#define FCGI_UNKNOWN_TYPE       11
#define FCGI_MAXTYPE (FCGI_UNKNOWN_TYPE)
```
 - 我们从宏观层面看完了FastCGI包，我们深入每个包的内部结构。通过上一篇笔记的学习我们知道，TCP/IP等协议的数据包，通常都是数据包**头部+包体**的结构，头部字段通常是一些描述信息，包体才真正地存储数据，这里FastCGI协议也不例外：
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/17/1563336273404.png)
### FastCGI数据包头部
```c
typedef struct {
    unsigned char version;            // 版本号
    unsigned char type;               // 数据包类型
    unsigned char requestIdB1;        // 包唯一标识id的高8位
    unsigned char requestIdB0;        // 包唯一标识id的低8位
    unsigned char contentLengthB1;    // 记录内容长度高8位(body长度高8位)
    unsigned char contentLengthB0;    // 记录内容长度低8位(body长度低8位)
    unsigned char paddingLength;      // 补齐位长度(body补齐长度)
    unsigned char reserved;           // 字节补齐位
}Header;
```
### FCGI_BEGIN_REQUEST
 - 以FCGI_BEGIN_REQUEST数据包为例，它也是同样的包头+包体的结构。
