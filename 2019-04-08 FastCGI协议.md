baiyan

全部视频：https://segmentfault.com/a/1190000018488313

## 为什么计算机网络架构是分层的
 - 我们经常谈到，计算机网络有多种体系架构，如OSI七层模型、TCP/IP四层模型等等。那么，为什么要将计算机网络分成如此多的层级呢？而且，每一层都要加上其特有的头部（如TCP头部、IP头部等等）进行封装，这样设计的原因何在？
 - 首先我们看一个我们经常看到的C/S架构数据流动过程图：
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/15/1563159003043.png)
 - 然后我们以TCP/IP四层网络体系架构总结一下各层服务的作用：
>  - **应用层**：用户直接能够操作的层，处理应用程序的逻辑，在用户空间实现
>  - **传输层**：为两台计算机上的应用程序提供端到端的通信，实现了数据经过网络层到达计算机后能够分发到各个端口（分用），在内核空间实现
>  - **网络层**：提供精确到两端计算机互联网IP地址的通信，实现了数据包在互联网上的选路与转发，在内核空间实现
>  - **数据链路层**：提供基于物理媒介（如网卡）的数据传输服务，在内核空间实现
 - 首先谈谈为什么要**分层**。在我们实际的项目开发过程中，我们常常提到的模块化、服务化，其实和计算机网络为什么要分层的原理类似。我们可以将每一层都看成一个模块、一个服务，其内部的实现细节对于上一层或者下一层都是隐藏的，可能只对外暴露一些API而已。如果上层要使用下层提供的服务，根本不需要关注下一层内部的实现细节，使用下层提供的API即可。这样一来，方便了开发与维护，进而提高了计算机网络整体的运作效率。
 - 我们再谈为什么要**封装**。刚才我们谈到了每个模块都是独立的。上层为了使用下层提供的服务，必须封装。举个例子，应用层想使用传输层提供的端到端的数据传输服务，那么传输层就会将应用层下发的数据先存起来。为了实现端到端的数据传输，传输层模块内部需要标识双方的端口号。所以，它就会将端口号还有一些额外的信息（被称作(TCP/UDP)首部），和应用层下发的数据部分进行封装，一起传给下一层（即网络层）。这样，通过封装每一层特有的头部，实现了每一层独特的功能，最终实现了精确到端口号的端到端数据传输服务。
## 为什么需要FastCGI协议
 - 在LNMP架构中，客户端浏览器与nginx代理是通过HTTP协议进行通信的。在请求到达nginx之后，数据最终会被转发给上游的PHP-FPM。它们之间的通信，属于同一机器上、不同端口号之间的通信。所以，它们也需要一个类似于HTTP的协议，需要一个格式或语法上的规范与约定。这样一来，通信双方才能够更好地理解并解析对方传输的信息以及数据。这个协议就是FastCGI协议。它基于传输层TCP协议
## 抓包观察
 - 接下来我们会以nginx与PHP-FPM之前通信的数据报为例，利用tcpdump抓取二者通信的数据报。所以我们首先需要了解一下各层数据报首部的格式，但是具体每个字段的作用，有许多文章曾经写过，在此不再赘述，详情请参考《Linux高性能服务器编程》或相关博客。
### 数据链路层
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/15/1563168518524.png)
### 网络层（IPv4协议）
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/15/1563168561052.png)
### 传输层（TCP协议）
![](http://baiyanzzz.oss-cn-beijing.aliyuncs.com/2019/7/15/1563168598661.png)

### TCP协议
 - TCP协议工作在TCP/IP体系架构的传输层。传输层一共有两个协议，一个是面向连接的、面向字节流的、提供可靠数据传输的TCP协议；另一个是无连接的、不提供可靠的数据传输的UDP协议。
 - 在使用TCP协议传输数据之前，需要建立一个端到端的连接。且TCP是面向字节流的，它把上面应用层交下来的数据看成无结构的字节流来发送，可以想象成一种流水的形式。发送方TCP会将数据放入它自己的“蓄水池”（缓冲区）中，等到可以发送的时候就发送，不能发送就等着。而且TCP会根据当前网络的拥塞状态来确定每个报文段的大小，而且它能够保证数据按序、无差错地到达目的地。到达目的地后，也会放入接收方的蓄水池（缓冲区）中。接收方可以一次性将所有字节数据读取，也可以分多次读取。接收方只知道一共需要读取多少个字节，但是每次读多少没有边界的限制。